- set_fact:
    CEPH_VERSION: "17.2.3"
    CODENAME: "focal"  ## this is derived from CEPH_VERSION i.e. debian-{{ CEPH_VERSION }}/dists/<pick_a_codename>/main
    CLUSTER_NAME: "{{ CLUSTER_NAME }}"
    # FSID: "ca98662e-19f3-47e3-a029-880ff75396ce"  ## generated by the command `uuidgen`
    CONFIG: "{{ lookup('hashivault', 'ceph', mount_point='service/secret', version=2)[CLUSTER_NAME] }}"
    FDE: "{{ lookup('hashivault', '{{ inventory_hostname }}', mount_point='service/machine', version=2)['fde'] }}"

- set_fact:
    DRIVE: "{{ FDE.keys() }}"

- debug:
    msg:
      - "CEPH_VERSION: {{ CEPH_VERSION }}"
      - "CODENAME: {{ CODENAME }}"
      - "CLUSTER_NAME: {{ CLUSTER_NAME }}"
      - "CONFIG: {{ CONFIG }}"
      - "DRIVE: {{ DRIVE }}"

- set_fact:
    CNODE: "{{ CNODE|default({}) | combine({item: lookup('dig', '{{ item }}')}) }}"
  with_items: "{{ play_hosts }}"

- set_fact:
    CNODE_INDEX: "{{ lookup('ansible.utils.index_of', '{{ play_hosts }}', 'regex', '{{ inventory_hostname }}') }}"

- debug:
    msg: "{{ CNODE }}"

- include_tasks: disk_setup.yaml
- include_tasks: prepare.yaml
- include_tasks: bootstrap.yaml
