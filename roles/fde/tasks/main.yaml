- name: install jq tpm2 and clevis packages
  package:
    name:
      - jq
      - tpm2-abrmd
      - tpm2-tools
      - clevis
      - clevis-tpm2
      - clevis-luks
      - clevis-initramfs
      - clevis-udisks2
      - clevis-systemd

- name: read secrets from vault
  set_fact:
    SECRET: "{{ lookup('hashivault', '{{ inventory_hostname }}', mount_point='/service/machine', version=2) }}"

- set_fact:
    SECRET: "{{ SECRET | combine({'fde': { item.key: {'path': '/dev/disk/by-id/'+item.value['bus']+'-'+item.key}}}, recursive=true) }}"
  with_dict: "{{ SECRET['fde'] }}"
  no_log: true

- include: fde.yaml
